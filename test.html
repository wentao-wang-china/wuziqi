<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºç¡€åŠŸèƒ½æµ‹è¯• - èµ›åšæœ‹å…‹äº”å­æ£‹</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/cyberpunk.css">
    <style>
        .test-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.95);
            padding: 20px;
            border: 2px solid #00f3ff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
            max-width: 300px;
            z-index: 1000;
        }

        .test-controls h3 {
            color: #00f3ff;
            margin-top: 0;
            text-shadow: 0 0 10px #00f3ff;
        }

        .test-btn {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 10px;
            background: transparent;
            border: 1px solid #00f3ff;
            color: #00f3ff;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .test-btn:hover {
            background: #00f3ff;
            color: #0a0e27;
            box-shadow: 0 0 10px #00f3ff;
        }

        .test-log {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #8000ff;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            color: #8000ff;
        }

        .log-item {
            margin: 3px 0;
            padding: 3px;
            border-left: 2px solid #8000ff;
            padding-left: 8px;
        }

        .log-success {
            border-left-color: #39ff14;
            color: #39ff14;
        }

        .log-error {
            border-left-color: #ff006e;
            color: #ff006e;
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>

    <div class="container">
        <header class="game-header">
            <h1 class="title text-glow">åŸºç¡€åŠŸèƒ½æµ‹è¯•</h1>
            <p class="subtitle">Testing: utils.js + board.js + game.js</p>
        </header>

        <main class="game-container">
            <section class="board-section">
                <div class="status-bar">
                    <div class="status-text" id="statusText">ç‚¹å‡»å³ä¾§æŒ‰é’®è¿›è¡Œæµ‹è¯•</div>
                </div>

                <canvas id="gameCanvas" width="660" height="660"></canvas>

                <div class="board-info">
                    <span class="info-item">
                        <span class="info-label">æµ‹è¯•çŠ¶æ€:</span>
                        <span class="info-value" id="testStatus">å¾…æµ‹è¯•</span>
                    </span>
                </div>
            </section>
        </main>
    </div>

    <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
    <div class="test-controls">
        <h3>æµ‹è¯•é¢æ¿</h3>

        <button class="test-btn" onclick="testUtils()">1. æµ‹è¯•å·¥å…·å‡½æ•°</button>
        <button class="test-btn" onclick="testBoard()">2. æµ‹è¯•æ£‹ç›˜æ¸²æŸ“</button>
        <button class="test-btn" onclick="testCoordinates()">3. æµ‹è¯•åæ ‡è½¬æ¢</button>
        <button class="test-btn" onclick="testMakeMove()">4. æµ‹è¯•è½å­åŠŸèƒ½</button>
        <button class="test-btn" onclick="testUndo()">5. æµ‹è¯•æ‚”æ£‹åŠŸèƒ½</button>
        <button class="test-btn" onclick="testWinCheck()">6. æµ‹è¯•äº”è¿åˆ¤å®š</button>
        <button class="test-btn" onclick="testGame()">7. æµ‹è¯•æ¸¸æˆæµç¨‹</button>
        <button class="test-btn" onclick="runAllTests()">â–¶ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button class="test-btn" onclick="resetAll()">ğŸ”„ é‡ç½®</button>

        <div class="test-log" id="testLog"></div>
    </div>

    <!-- å¼•å…¥JSæ¨¡å— -->
    <script src="js/utils.js"></script>
    <script src="js/board.js"></script>
    <script src="js/game.js"></script>

    <!-- æµ‹è¯•è„šæœ¬ -->
    <script>
        let game = null;
        let testResults = [];

        // æ—¥å¿—å‡½æ•°
        function log(message, isSuccess = true) {
            const logDiv = document.getElementById('testLog');
            const logItem = document.createElement('div');
            logItem.className = isSuccess ? 'log-item log-success' : 'log-item log-error';
            logItem.textContent = message;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
            testResults = [];
        }

        function updateStatus(text, color = '#00f3ff') {
            const statusEl = document.getElementById('statusText');
            const testStatusEl = document.getElementById('testStatus');
            statusEl.textContent = text;
            statusEl.style.color = color;
            testStatusEl.textContent = text;
        }

        // æµ‹è¯•1: å·¥å…·å‡½æ•°
        function testUtils() {
            log('=== æµ‹è¯•å·¥å…·å‡½æ•° ===');

            try {
                // æµ‹è¯•å¸¸é‡
                log(`âœ“ BOARD_SIZE = ${CONSTANTS.BOARD_SIZE}`);
                log(`âœ“ PLAYER_BLACK = ${CONSTANTS.PLAYER_BLACK}`);

                // æµ‹è¯•è¾…åŠ©å‡½æ•°
                const valid = isValidPosition(7, 7);
                log(`âœ“ isValidPosition(7,7) = ${valid}`, valid);

                const invalid = isValidPosition(-1, 5);
                log(`âœ“ isValidPosition(-1,5) = ${invalid}`, !invalid);

                const opponent = getOpponent('black');
                log(`âœ“ getOpponent('black') = ${opponent}`, opponent === 'white');

                const name = getPlayerName('black');
                log(`âœ“ getPlayerName('black') = ${name}`);

                // æµ‹è¯•Timer
                Timer.start('test');
                const time = Timer.end('test');
                log(`âœ“ Timeræµ‹è¯•: ${formatTime(time)}`);

                updateStatus('âœ… å·¥å…·å‡½æ•°æµ‹è¯•é€šè¿‡', '#39ff14');
                testResults.push({name: 'Utils', pass: true});

            } catch (error) {
                log(`âœ— å·¥å…·å‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`, false);
                updateStatus('âŒ å·¥å…·å‡½æ•°æµ‹è¯•å¤±è´¥', '#ff006e');
                testResults.push({name: 'Utils', pass: false});
            }
        }

        // æµ‹è¯•2: æ£‹ç›˜æ¸²æŸ“
        function testBoard() {
            log('=== æµ‹è¯•æ£‹ç›˜æ¸²æŸ“ ===');

            try {
                const board = new Board();
                const success = board.init('gameCanvas');

                if (!success) {
                    throw new Error('æ£‹ç›˜åˆå§‹åŒ–å¤±è´¥');
                }

                log(`âœ“ æ£‹ç›˜åˆå§‹åŒ–æˆåŠŸ`);
                log(`âœ“ æ£‹ç›˜å¤§å°: ${board.size}x${board.size}`);
                log(`âœ“ æ ¼å­å¤§å°: ${board.cellSize}px`);
                log(`âœ“ Canvas: ${board.canvas.width}x${board.canvas.height}`);

                // æ£€æŸ¥ç½‘æ ¼æ˜¯å¦ä¸ºç©º
                let isEmpty = true;
                for (let i = 0; i < board.size; i++) {
                    for (let j = 0; j < board.size; j++) {
                        if (board.grid[i][j] !== null) isEmpty = false;
                    }
                }
                log(`âœ“ æ£‹ç›˜åˆå§‹ä¸ºç©º: ${isEmpty}`, isEmpty);

                updateStatus('âœ… æ£‹ç›˜æ¸²æŸ“æµ‹è¯•é€šè¿‡', '#39ff14');
                testResults.push({name: 'Board', pass: true});

            } catch (error) {
                log(`âœ— æ£‹ç›˜æµ‹è¯•å¤±è´¥: ${error.message}`, false);
                updateStatus('âŒ æ£‹ç›˜æµ‹è¯•å¤±è´¥', '#ff006e');
                testResults.push({name: 'Board', pass: false});
            }
        }

        // æµ‹è¯•3: åæ ‡è½¬æ¢
        function testCoordinates() {
            log('=== æµ‹è¯•åæ ‡è½¬æ¢ ===');

            try {
                if (!game) {
                    game = new Game();
                    game.init();
                }

                const board = game.board;

                // æµ‹è¯•getCellCenter
                const center = board.getCellCenter(7, 7);
                log(`âœ“ ä¸­å¿ƒç‚¹(7,7)åƒç´ åæ ‡: (${center.x}, ${center.y})`);

                // æµ‹è¯•å·¦ä¸Šè§’
                const corner = board.getCellCenter(0, 0);
                log(`âœ“ å·¦ä¸Šè§’(0,0)åƒç´ åæ ‡: (${corner.x}, ${corner.y})`);

                // æµ‹è¯•å³ä¸‹è§’
                const bottomRight = board.getCellCenter(14, 14);
                log(`âœ“ å³ä¸‹è§’(14,14)åƒç´ åæ ‡: (${bottomRight.x}, ${bottomRight.y})`);

                updateStatus('âœ… åæ ‡è½¬æ¢æµ‹è¯•é€šè¿‡', '#39ff14');
                testResults.push({name: 'Coordinates', pass: true});

            } catch (error) {
                log(`âœ— åæ ‡è½¬æ¢æµ‹è¯•å¤±è´¥: ${error.message}`, false);
                updateStatus('âŒ åæ ‡è½¬æ¢æµ‹è¯•å¤±è´¥', '#ff006e');
                testResults.push({name: 'Coordinates', pass: false});
            }
        }

        // æµ‹è¯•4: è½å­åŠŸèƒ½
        function testMakeMove() {
            log('=== æµ‹è¯•è½å­åŠŸèƒ½ ===');

            try {
                if (!game) {
                    game = new Game();
                    game.init();
                }

                const board = game.board;
                board.reset();

                // æµ‹è¯•è½é»‘å­
                const success1 = board.makeMove(7, 7, 'black');
                log(`âœ“ ä¸­å¿ƒç‚¹è½é»‘å­: ${success1}`, success1);
                log(`âœ“ å†å²è®°å½•æ•°: ${board.history.length}`, board.history.length === 1);

                // æµ‹è¯•è½ç™½å­
                const success2 = board.makeMove(7, 8, 'white');
                log(`âœ“ (7,8)è½ç™½å­: ${success2}`, success2);

                // æµ‹è¯•é‡å¤è½å­ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
                const success3 = board.makeMove(7, 7, 'black');
                log(`âœ“ é‡å¤è½å­è¢«æ‹’ç»: ${!success3}`, !success3);

                // æµ‹è¯•æ£‹ç›˜çŠ¶æ€
                log(`âœ“ (7,7)ä½ç½®: ${board.grid[7][7]}`, board.grid[7][7] === 'black');
                log(`âœ“ (7,8)ä½ç½®: ${board.grid[7][8]}`, board.grid[7][8] === 'white');

                updateStatus('âœ… è½å­åŠŸèƒ½æµ‹è¯•é€šè¿‡', '#39ff14');
                testResults.push({name: 'MakeMove', pass: true});

            } catch (error) {
                log(`âœ— è½å­æµ‹è¯•å¤±è´¥: ${error.message}`, false);
                updateStatus('âŒ è½å­æµ‹è¯•å¤±è´¥', '#ff006e');
                testResults.push({name: 'MakeMove', pass: false});
            }
        }

        // æµ‹è¯•5: æ‚”æ£‹åŠŸèƒ½
        function testUndo() {
            log('=== æµ‹è¯•æ‚”æ£‹åŠŸèƒ½ ===');

            try {
                if (!game) {
                    game = new Game();
                    game.init();
                }

                const board = game.board;
                board.reset();

                // è½å‡ æ­¥æ£‹
                board.makeMove(7, 7, 'black');
                board.makeMove(7, 8, 'white');
                board.makeMove(8, 7, 'black');

                const beforeUndo = board.history.length;
                log(`âœ“ æ‚”æ£‹å‰å†å²è®°å½•: ${beforeUndo}æ­¥`);

                // æ‚”æ£‹
                const undoMove = board.undoMove();
                log(`âœ“ æ‚”æ£‹æˆåŠŸï¼Œæ’¤é”€: (${undoMove.row}, ${undoMove.col})`);
                log(`âœ“ æ‚”æ£‹åå†å²è®°å½•: ${board.history.length}æ­¥`);
                log(`âœ“ (8,7)ä½ç½®å·²æ¸…ç©º: ${board.grid[8][7] === null}`, board.grid[8][7] === null);

                updateStatus('âœ… æ‚”æ£‹åŠŸèƒ½æµ‹è¯•é€šè¿‡', '#39ff14');
                testResults.push({name: 'Undo', pass: true});

            } catch (error) {
                log(`âœ— æ‚”æ£‹æµ‹è¯•å¤±è´¥: ${error.message}`, false);
                updateStatus('âŒ æ‚”æ£‹æµ‹è¯•å¤±è´¥', '#ff006e');
                testResults.push({name: 'Undo', pass: false});
            }
        }

        // æµ‹è¯•6: äº”è¿åˆ¤å®š
        function testWinCheck() {
            log('=== æµ‹è¯•äº”è¿åˆ¤å®š ===');

            try {
                if (!game) {
                    game = new Game();
                    game.init();
                }

                game.board.reset();

                // æµ‹è¯•æ°´å¹³äº”è¿
                log('æµ‹è¯•æ°´å¹³äº”è¿:');
                for (let i = 0; i < 5; i++) {
                    game.board.makeMove(7, i, 'black');
                }
                const winH = game.checkWin(7, 4, 'black');
                log(`âœ“ æ°´å¹³äº”è¿æ£€æµ‹: ${winH}`, winH);
                if (winH) {
                    log(`âœ“ äº”è¿çº¿åæ ‡: ${JSON.stringify(game.winLine)}`);
                }

                // é‡ç½®å¹¶æµ‹è¯•å‚ç›´äº”è¿
                game.board.reset();
                log('æµ‹è¯•å‚ç›´äº”è¿:');
                for (let i = 0; i < 5; i++) {
                    game.board.makeMove(i, 7, 'white');
                }
                const winV = game.checkWin(4, 7, 'white');
                log(`âœ“ å‚ç›´äº”è¿æ£€æµ‹: ${winV}`, winV);

                // é‡ç½®å¹¶æµ‹è¯•æ–œçº¿äº”è¿
                game.board.reset();
                log('æµ‹è¯•å³ä¸‹æ–œäº”è¿:');
                for (let i = 0; i < 5; i++) {
                    game.board.makeMove(i, i, 'black');
                }
                const winD = game.checkWin(4, 4, 'black');
                log(`âœ“ å³ä¸‹æ–œäº”è¿æ£€æµ‹: ${winD}`, winD);

                // æµ‹è¯•éäº”è¿
                game.board.reset();
                game.board.makeMove(0, 0, 'black');
                game.board.makeMove(0, 1, 'black');
                game.board.makeMove(0, 2, 'black');
                const noWin = game.checkWin(0, 2, 'black');
                log(`âœ“ ä¸‰è¿ä¸åˆ¤å®šä¸ºèƒœåˆ©: ${!noWin}`, !noWin);

                updateStatus('âœ… äº”è¿åˆ¤å®šæµ‹è¯•é€šè¿‡', '#39ff14');
                testResults.push({name: 'WinCheck', pass: true});

            } catch (error) {
                log(`âœ— äº”è¿åˆ¤å®šæµ‹è¯•å¤±è´¥: ${error.message}`, false);
                updateStatus('âŒ äº”è¿åˆ¤å®šæµ‹è¯•å¤±è´¥', '#ff006e');
                testResults.push({name: 'WinCheck', pass: false});
            }
        }

        // æµ‹è¯•7: æ¸¸æˆæµç¨‹
        function testGame() {
            log('=== æµ‹è¯•æ¸¸æˆæµç¨‹ ===');

            try {
                if (!game) {
                    game = new Game();
                    game.init();
                }

                // æµ‹è¯•æ¸¸æˆåˆå§‹åŒ–
                log(`âœ“ æ¸¸æˆçŠ¶æ€: ${game.gameState}`);
                log(`âœ“ å½“å‰ç©å®¶: ${game.currentPlayer}`);

                // æµ‹è¯•å¼€å§‹æ¸¸æˆ
                game.start('medium', 'black');
                log(`âœ“ æ¸¸æˆå·²å¼€å§‹`);
                log(`âœ“ éš¾åº¦: ${game.difficulty}`);
                log(`âœ“ ç©å®¶æ‰§: ${game.playerSide}`);
                log(`âœ“ AIæ‰§: ${game.aiSide}`);

                // æµ‹è¯•ç©å®¶è½å­
                const moveSuccess = game.handlePlayerMove(7, 7);
                log(`âœ“ ç©å®¶è½å­(7,7): ${moveSuccess}`, moveSuccess);

                // æµ‹è¯•æ¸¸æˆç»Ÿè®¡
                const stats = game.getStats();
                log(`âœ“ é»‘å­æ•°: ${stats.blackCount}`);
                log(`âœ“ ç™½å­æ•°: ${stats.whiteCount}`);
                log(`âœ“ ç©ºä½æ•°: ${stats.emptyCount}`);
                log(`âœ“ æ€»æ­¥æ•°: ${stats.totalMoves}`);

                updateStatus('âœ… æ¸¸æˆæµç¨‹æµ‹è¯•é€šè¿‡', '#39ff14');
                testResults.push({name: 'Game', pass: true});

            } catch (error) {
                log(`âœ— æ¸¸æˆæµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, false);
                updateStatus('âŒ æ¸¸æˆæµç¨‹æµ‹è¯•å¤±è´¥', '#ff006e');
                testResults.push({name: 'Game', pass: false});
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            clearLog();
            log('========================================');
            log('å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            log('========================================');

            testUtils();
            await delay(200);

            testBoard();
            await delay(200);

            testCoordinates();
            await delay(200);

            testMakeMove();
            await delay(200);

            testUndo();
            await delay(200);

            testWinCheck();
            await delay(200);

            testGame();
            await delay(200);

            // æ±‡æ€»ç»“æœ
            log('========================================');
            const passed = testResults.filter(r => r.pass).length;
            const total = testResults.length;
            log(`æµ‹è¯•å®Œæˆ: ${passed}/${total} é€šè¿‡`);

            if (passed === total) {
                log('ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', true);
                updateStatus(`âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ (${passed}/${total})`, '#39ff14');
            } else {
                log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥', false);
                updateStatus(`âš ï¸ æµ‹è¯•é€šè¿‡ ${passed}/${total}`, '#ff006e');
            }
            log('========================================');
        }

        // é‡ç½®
        function resetAll() {
            clearLog();
            if (game) {
                game.board.reset();
            }
            updateStatus('å·²é‡ç½®ï¼Œå‡†å¤‡æµ‹è¯•', '#00f3ff');
            log('ç³»ç»Ÿå·²é‡ç½®');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('%c=== åŸºç¡€åŠŸèƒ½æµ‹è¯• ===', 'color: #00f3ff; font-size: 20px; font-weight: bold;');
            log('æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª');
            log('ç‚¹å‡»å³ä¾§æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
